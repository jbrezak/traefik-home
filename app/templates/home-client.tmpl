<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Traefik Home</title>
    <link rel="stylesheet" href="" id="custom-css">
    <style>
        /* Embed original.css inline as base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            padding: 2rem;
        }

        body.custom-background {
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: #1a1a1a;
                color: #e0e0e0;
            }
            
            h1 {
                color: #ffffff !important;
            }
            
            .service-card {
                background: #2d2d2d;
                color: #e0e0e0;
            }
            
            .service-name {
                color: #ffffff;
            }
            
            .service-url {
                color: #b0b0b0;
            }
            
            .service-url:hover {
                color: #64b5f6;
            }
            
            .dropdown-menu {
                background: #2d2d2d;
                border: 1px solid #404040;
            }
            
            .dropdown-header {
                border-bottom-color: #404040;
            }
            
            .dropdown-username {
                color: #ffffff;
            }
            
            .dropdown-item {
                color: #b0b0b0;
            }
            
            .dropdown-item:hover {
                background: #383838;
            }
            
            .dropdown-item.logout:hover {
                background: #3d1f1f;
            }
            
            footer {
                border-top-color: #404040;
                color: #b0b0b0;
            }
            
            .admin-section {
                border-top: none !important;
            }

            .admin-header h2 {
                color: #ef5350;
            }

            .admin-badge {
                background: #ef5350;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 {
            color: #333;
            margin: 0;
        }

        .user-menu-container {
            position: relative;
            display: none;
        }

        .user-menu-container.active {
            display: block;
        }

        .user-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .user-button:active {
            transform: scale(0.98);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
            z-index: 1000;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .dropdown-username {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item.logout {
            color: #f44336;
            border-top: 1px solid #e0e0e0;
        }

        .dropdown-item.logout:hover {
            background: #ffebee;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .service-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .service-icon {
            width: 48px;
            height: 48px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .service-info {
            flex: 1;
            min-width: 0;
        }

        .service-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 0.25rem;
            word-wrap: break-word;
        }

        .service-url {
            color: #666;
            font-size: 0.9rem;
            text-decoration: none;
            word-break: break-all;
        }

        .service-url:hover {
            color: #0066cc;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-online {
            background: #4caf50;
        }

        .status-offline {
            background: #f44336;
        }

        .status-dot.hidden {
            display: none;
        }

        /* Admin section styles */
        .admin-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: none !important;
            display: none;
        }

        .admin-section.visible {
            display: block;
        }

        .admin-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
            margin-bottom: 1.5rem;
        }

        .admin-header h2 {
            margin: 0;
            color: #d32f2f;
            font-size: 1.5rem;
        }

        .admin-badge {
            background: #d32f2f;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .admin-toggle {
            margin-left: auto;
            transition: transform 0.3s ease;
        }

        .admin-toggle.expanded {
            transform: rotate(180deg);
        }

        .admin-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .admin-content.expanded {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9rem;
        }

        footer.hidden {
            display: none;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .dropdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 999;
        }

        .dropdown-overlay.show {
            display: block;
        }

        .loading {
            text-align: center;
            font-size: 1.2rem;
            margin-top: 3rem;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 1rem;
            border-radius: 8px;
            margin: 2rem 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="page-title">Traefik Home</h1>
            <div class="user-menu-container" id="userMenuContainer">
                <button class="user-button" id="userButton" aria-label="User menu"></button>
                <div class="dropdown-overlay" id="dropdownOverlay"></div>
                <div class="dropdown-menu" id="dropdownMenu">
                    <div class="dropdown-header">
                        <div class="dropdown-username" id="fullUsername"></div>
                    </div>
                    <div class="dropdown-item logout" id="logoutButton">
                        <span>ðŸšª</span>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">Loading services...</div>
        <div id="error" class="error-message" style="display: none;"></div>
        
        <div class="services-grid" id="mainServicesGrid"></div>

        <div class="admin-section" id="adminSection">
            <div class="admin-header" id="adminHeader">
                <h2>ðŸ”§ Administration</h2>
                <span class="admin-badge">ADMIN ONLY</span>
                <svg class="admin-toggle" id="adminToggle" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="admin-content" id="adminContent">
                <div class="services-grid" id="adminServicesGrid"></div>
            </div>
        </div>

        <footer id="footer" class="hidden">
            <p>Traefik Home</p>
            <p>Generated: <span id="generated-time"></span></p>
        </footer>
    </div>

    <script>
        // Configuration will be loaded from apps.json
        let config = {
            page_title: 'Traefik Home',
            custom_css_url: '/custom.css',
            custom_background_url: '',
            authentik_logout_url: '',
            show_footer: true,
            show_status_dot: true,
            open_in_new_tab: false,
            sort_by: 'default'
        };

        // Apply configuration
        function applyConfig(cfg) {
            config = cfg;
            
            // Set page title
            document.getElementById('page-title').textContent = config.page_title;
            
            // Set custom CSS if provided
            if (config.custom_css_url) {
                document.getElementById('custom-css').href = config.custom_css_url;
            }
            
            // Set custom background if provided
            if (config.custom_background_url) {
                document.body.style.backgroundImage = `url('${config.custom_background_url}')`;
                document.body.classList.add('custom-background');
            }
            
            // Show/hide footer
            if (config.show_footer) {
                document.getElementById('footer').classList.remove('hidden');
            }
            
            // Setup user menu if Authentik is configured
            if (config.authentik_logout_url) {
                fetchUserInfo();
            }
        }

        // Fetch user info from the API endpoint
        async function fetchUserInfo() {
            try {
                const response = await fetch('/api/user-info', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    return null;
                }
                
                const data = await response.json();
                
                // Check if username exists and is not empty
                if (data.username && data.username !== '' && data.username !== '$http_x_authentik_username') {
                    displayUserMenu({
                        username: data.username,
                        email: data.email,
                        name: data.name,
                        isAdmin: data.isAdmin === 'true'
                    });
                    return data;
                }
                
                return null;
            } catch (error) {
                console.error('Failed to fetch user info:', error);
                return null;
            }
        }

        // Display user menu
        function displayUserMenu(userInfo) {
            const menuContainer = document.getElementById('userMenuContainer');
            const userButton = document.getElementById('userButton');
            const fullUsername = document.getElementById('fullUsername');
            const logoutButton = document.getElementById('logoutButton');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const dropdownOverlay = document.getElementById('dropdownOverlay');
            
            menuContainer.classList.add('active');
            
            // Set user initials in button
            const initials = userInfo.username ? userInfo.username.substring(0, 2).toUpperCase() : '??';
            userButton.textContent = initials;
            
            // Set full username in dropdown
            fullUsername.textContent = userInfo.name || userInfo.username;
            
            // Setup logout link
            logoutButton.onclick = () => {
                if (config.authentik_logout_url) {
                    window.location.href = config.authentik_logout_url;
                }
            };
            
            // Toggle dropdown on button click
            userButton.onclick = (e) => {
                e.stopPropagation();
                const isVisible = dropdownMenu.classList.contains('show');
                if (isVisible) {
                    dropdownMenu.classList.remove('show');
                    dropdownOverlay.classList.remove('show');
                } else {
                    dropdownMenu.classList.add('show');
                    dropdownOverlay.classList.add('show');
                }
            };
            
            // Close dropdown when clicking overlay
            dropdownOverlay.onclick = () => {
                dropdownMenu.classList.remove('show');
                dropdownOverlay.classList.remove('show');
            };
        }

        // Select preferred URL based on current hostname
        function selectPreferredUrl(urls) {
            if (!urls || urls.length === 0) return null;
            if (urls.length === 1) return urls[0];

            const currentHost = window.location.hostname;
            
            // Try to find URL with matching hostname
            for (const url of urls) {
                try {
                    const urlObj = new URL(url);
                    if (urlObj.hostname === currentHost || 
                        urlObj.hostname.endsWith('.' + currentHost) ||
                        currentHost.endsWith('.' + urlObj.hostname)) {
                        return url;
                    }
                } catch (e) {
                    console.warn('Invalid URL:', url, e);
                }
            }
            
            // Default to first URL
            return urls[0];
        }

        // Render a service card
        function renderServiceCard(app) {
            const link = document.createElement('a');
            link.href = '#';
            
            const card = document.createElement('div');
            card.className = 'service-card';

            // Add icon if present
            if (app.icon) {
                const icon = document.createElement('img');
                icon.src = app.icon;
                icon.alt = app.name;
                icon.className = 'service-icon';
                card.appendChild(icon);
            }

            // Service info container
            const info = document.createElement('div');
            info.className = 'service-info';

            // Add status dot if enabled
            if (config.show_status_dot) {
                const statusDot = document.createElement('div');
                statusDot.className = 'status-dot status-online';
                info.appendChild(statusDot);
            }

            // Service name
            const name = document.createElement('div');
            name.className = 'service-name';
            name.textContent = app.name;
            info.appendChild(name);

            // Service URL (preferred)
            const preferredUrl = selectPreferredUrl(app.urls);
            if (preferredUrl) {
                const url = document.createElement('div');
                url.className = 'service-url';
                url.textContent = preferredUrl;
                info.appendChild(url);
                
                // Setup click handler
                link.onclick = (e) => {
                    e.preventDefault();
                    if (config.open_in_new_tab) {
                        window.open(preferredUrl, '_blank');
                    } else {
                        window.location.href = preferredUrl;
                    }
                };
            }

            card.appendChild(info);
            link.appendChild(card);
            
            return link;
        }

        // Render apps
        function renderApps(apps) {
            const mainGrid = document.getElementById('mainServicesGrid');
            const adminGrid = document.getElementById('adminServicesGrid');
            const adminSection = document.getElementById('adminSection');
            
            mainGrid.innerHTML = '';
            adminGrid.innerHTML = '';

            // Sort apps based on config
            if (config.sort_by === 'name') {
                apps.sort((a, b) => a.name.localeCompare(b.name));
            }

            let hasAdminApps = false;

            // Render each app
            apps.forEach(app => {
                const card = renderServiceCard(app);
                
                // Check if this is an admin app (category contains "Admin")
                if (app.category && app.category.toLowerCase().includes('admin')) {
                    adminGrid.appendChild(card);
                    hasAdminApps = true;
                } else {
                    mainGrid.appendChild(card);
                }
            });

            // Show admin section if there are admin apps
            if (hasAdminApps) {
                adminSection.classList.add('visible');
                setupAdminToggle();
            }
        }

        // Setup admin section toggle
        function setupAdminToggle() {
            const adminHeader = document.getElementById('adminHeader');
            const adminToggle = document.getElementById('adminToggle');
            const adminContent = document.getElementById('adminContent');

            adminHeader.onclick = () => {
                const isExpanded = adminContent.classList.contains('expanded');
                if (isExpanded) {
                    adminContent.classList.remove('expanded');
                    adminToggle.classList.remove('expanded');
                } else {
                    adminContent.classList.add('expanded');
                    adminToggle.classList.add('expanded');
                }
            };
        }

        // Load apps
        fetch('/apps.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load apps.json');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                
                // Apply configuration if present
                if (data.config) {
                    applyConfig(data.config);
                }
                
                // Set generated time
                if (data._generated) {
                    const genTime = new Date(data._generated);
                    document.getElementById('generated-time').textContent = genTime.toLocaleString();
                }
                
                if (data.apps && data.apps.length > 0) {
                    renderApps(data.apps);
                } else {
                    document.getElementById('error').textContent = 'No apps found';
                    document.getElementById('error').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading apps:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = 'Failed to load apps: ' + error.message;
                document.getElementById('error').style.display = 'block';
            });
    </script>
</body>
</html>
