<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Traefik Home</title>
    <link rel="stylesheet" href="" id="custom-css">
    <style>
        /* Embed original.css inline as base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            padding: 2rem;
        }

        body.custom-background {
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: #1a1a1a;
                color: #e0e0e0;
            }
            
            h1 {
                color: #ffffff !important;
            }
            
            .service-card {
                background: #2d2d2d;
                color: #e0e0e0;
            }
            
            .service-name {
                color: #ffffff;
            }
            
            .service-url {
                color: #b0b0b0;
            }
            
            .service-url:hover {
                color: #64b5f6;
            }
            
            .dropdown-menu {
                background: #2d2d2d;
                border: 1px solid #404040;
            }
            
            .dropdown-header {
                border-bottom-color: #404040;
            }
            
            .dropdown-username {
                color: #ffffff;
            }
            
            .dropdown-item {
                color: #b0b0b0;
            }
            
            .dropdown-item:hover {
                background: #383838;
            }
            
            .dropdown-item.logout:hover {
                background: #3d1f1f;
            }
            
            footer {
                border-top-color: #404040;
                color: #b0b0b0;
            }
            
            .admin-section {
                border-top: none !important;
            }

            .admin-header h2 {
                color: #ef5350;
            }

            .admin-badge {
                background: #ef5350;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 {
            color: #333;
            margin: 0;
        }

        .user-menu-container {
            position: relative;
            display: none;
        }

        .user-menu-container.active {
            display: block;
        }

        .user-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            position: relative;
        }
        
        .user-button img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .user-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .user-button:active {
            transform: scale(0.98);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
            z-index: 1000;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .dropdown-username {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item.logout {
            color: #f44336;
            border-top: 1px solid #e0e0e0;
        }

        .dropdown-item.logout:hover {
            background: #ffebee;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .service-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .service-icon {
            width: 48px;
            height: 48px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .service-info {
            flex: 1;
            min-width: 0;
        }

        .service-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 0.25rem;
            word-wrap: break-word;
        }

        .service-url {
            color: #666;
            font-size: 0.9rem;
            text-decoration: none;
            word-break: break-all;
        }

        .service-url:hover {
            color: #0066cc;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-online {
            background: #4caf50;
        }

        .status-offline {
            background: #f44336;
        }

        .status-dot.hidden {
            display: none;
        }

        /* Admin section styles */
        .admin-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: none !important;
            display: none;
        }

        .admin-section.visible {
            display: block;
        }

        .admin-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
            margin-bottom: 1.5rem;
        }

        .admin-header h2 {
            margin: 0;
            color: #d32f2f;
            font-size: 1.5rem;
        }

        .admin-badge {
            background: #d32f2f;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .admin-toggle {
            margin-left: auto;
            transition: transform 0.3s ease;
        }

        .admin-toggle.expanded {
            transform: rotate(180deg);
        }

        .admin-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .admin-content.expanded {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9rem;
        }

        footer.hidden {
            display: none;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .dropdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 999;
        }

        .dropdown-overlay.show {
            display: block;
        }

        .loading {
            text-align: center;
            font-size: 1.2rem;
            margin-top: 3rem;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 1rem;
            border-radius: 8px;
            margin: 2rem 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="page-title">Traefik Home</h1>
            <div class="user-menu-container" id="userMenuContainer">
                <button class="user-button" id="userButton" aria-label="User menu"></button>
                <div class="dropdown-overlay" id="dropdownOverlay"></div>
                <div class="dropdown-menu" id="dropdownMenu">
                    <div class="dropdown-header">
                        <div class="dropdown-username" id="fullUsername"></div>
                    </div>
                    <div class="dropdown-item logout" id="logoutButton">
                        <span>ðŸšª</span>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">Loading services...</div>
        <div id="error" class="error-message" style="display: none;"></div>
        
        <div class="services-grid" id="mainServicesGrid"></div>

        <div class="admin-section" id="adminSection">
            <div class="admin-header" id="adminHeader">
                <h2>ðŸ”§ Administration</h2>
                <span class="admin-badge">ADMIN ONLY</span>
                <svg class="admin-toggle" id="adminToggle" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="admin-content" id="adminContent">
                <div class="services-grid" id="adminServicesGrid"></div>
            </div>
        </div>

        <footer id="footer" class="hidden">
            <p>Traefik Home</p>
            <p>Generated: <span id="generated-time"></span></p>
        </footer>
    </div>

    <script>
        // Configuration will be loaded from apps.json
        let config = {
            page_title: 'Traefik Home',
            custom_css_url: '/custom.css',
            custom_background_url: '',
            authentik_logout_url: '',
            show_footer: true,
            show_status_dot: true,
            open_in_new_tab: false,
            sort_by: 'default'
        };

        // Apply configuration
        function applyConfig(cfg) {
            config = cfg;
            
            // Set page title
            document.getElementById('page-title').textContent = config.page_title;
            
            // Set custom CSS if provided
            if (config.custom_css_url) {
                document.getElementById('custom-css').href = config.custom_css_url;
            }
            
            // Set custom background if provided
            if (config.custom_background_url) {
                document.body.style.backgroundImage = `url('${config.custom_background_url}')`;
                document.body.classList.add('custom-background');
            }
            
            // Show/hide footer
            if (config.show_footer) {
                document.getElementById('footer').classList.remove('hidden');
            }
            
            // Setup user menu if Authentik is configured
            if (config.authentik_logout_url) {
                fetchUserInfo();
            }
        }

        // Fetch user info from the API endpoint
        async function fetchUserInfo() {
            try {
                // Add cache-busting parameter to prevent stale data after logout
                const cacheBuster = Date.now();
                const response = await fetch(`/api/user-info?_=${cacheBuster}`, {
                    credentials: 'include',
                    cache: 'no-store'
                });
                
                if (!response.ok) {
                    return null;
                }
                
                const data = await response.json();
                
                // Check if username exists and is not empty
                if (data.username && data.username !== '' && data.username !== '$http_x_authentik_username') {
                    displayUserMenu({
                        username: data.username,
                        email: data.email,
                        name: data.name,
                        isAdmin: data.isAdmin === 'true'
                    });
                    return data;
                }
                
                // User is not logged in - hide user menu
                hideUserMenu();
                return null;
            } catch (error) {
                console.error('Failed to fetch user info:', error);
                hideUserMenu();
                return null;
            }
        }

        // Hide user menu when not authenticated
        function hideUserMenu() {
            const menuContainer = document.getElementById('userMenuContainer');
            if (menuContainer) {
                menuContainer.classList.remove('active');
                menuContainer.style.display = 'none';
            }
        }

        // Display user menu
        function displayUserMenu(userInfo) {
            const menuContainer = document.getElementById('userMenuContainer');
            const userButton = document.getElementById('userButton');
            const fullUsername = document.getElementById('fullUsername');
            const logoutButton = document.getElementById('logoutButton');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const dropdownOverlay = document.getElementById('dropdownOverlay');
            
            menuContainer.classList.add('active');
            
            // Check if user has Gravatar email
            if (userInfo.email) {
                // Use Gravatar
                const gravatarHash = md5(userInfo.email.toLowerCase().trim());
                const gravatarUrl = `https://www.gravatar.com/avatar/${gravatarHash}?s=96&d=identicon`;
                
                const img = document.createElement('img');
                img.src = gravatarUrl;
                img.alt = userInfo.username;
                img.onerror = function() {
                    // Fallback to initials if Gravatar fails
                    this.remove();
                    const initials = userInfo.username ? userInfo.username.substring(0, 2).toUpperCase() : '??';
                    userButton.textContent = initials;
                };
                userButton.appendChild(img);
            } else {
                // Use initials if no email
                const initials = userInfo.username ? userInfo.username.substring(0, 2).toUpperCase() : '??';
                userButton.textContent = initials;
            }
            
            // Set full username in dropdown
            fullUsername.textContent = userInfo.name || userInfo.username;
            
            // Setup logout link
            logoutButton.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (config.authentik_logout_url) {
                    // Clear any cached data before redirecting
                    sessionStorage.clear();
                    localStorage.clear();
                    
                    // Redirect to logout URL
                    window.location.replace(config.authentik_logout_url);
                }
            };
            
            // Toggle dropdown on button click
            userButton.onclick = (e) => {
                e.stopPropagation();
                const isVisible = dropdownMenu.classList.contains('show');
                if (isVisible) {
                    dropdownMenu.classList.remove('show');
                    dropdownOverlay.classList.remove('show');
                } else {
                    dropdownMenu.classList.add('show');
                    dropdownOverlay.classList.add('show');
                }
            };
            
            // Close dropdown when clicking overlay
            dropdownOverlay.onclick = () => {
                dropdownMenu.classList.remove('show');
                dropdownOverlay.classList.remove('show');
            };
        }
        
        // Simple MD5 implementation for Gravatar hashing
        function md5(string) {
            function md5cycle(x, k) {
                var a = x[0], b = x[1], c = x[2], d = x[3];
                a = ff(a, b, c, d, k[0], 7, -680876936);
                d = ff(d, a, b, c, k[1], 12, -389564586);
                c = ff(c, d, a, b, k[2], 17, 606105819);
                b = ff(b, c, d, a, k[3], 22, -1044525330);
                a = ff(a, b, c, d, k[4], 7, -176418897);
                d = ff(d, a, b, c, k[5], 12, 1200080426);
                c = ff(c, d, a, b, k[6], 17, -1473231341);
                b = ff(b, c, d, a, k[7], 22, -45705983);
                a = ff(a, b, c, d, k[8], 7, 1770035416);
                d = ff(d, a, b, c, k[9], 12, -1958414417);
                c = ff(c, d, a, b, k[10], 17, -42063);
                b = ff(b, c, d, a, k[11], 22, -1990404162);
                a = ff(a, b, c, d, k[12], 7, 1804603682);
                d = ff(d, a, b, c, k[13], 12, -40341101);
                c = ff(c, d, a, b, k[14], 17, -1502002290);
                b = ff(b, c, d, a, k[15], 22, 1236535329);
                a = gg(a, b, c, d, k[1], 5, -165796510);
                d = gg(d, a, b, c, k[6], 9, -1069501632);
                c = gg(c, d, a, b, k[11], 14, 643717713);
                b = gg(b, c, d, a, k[0], 20, -373897302);
                a = gg(a, b, c, d, k[5], 5, -701558691);
                d = gg(d, a, b, c, k[10], 9, 38016083);
                c = gg(c, d, a, b, k[15], 14, -660478335);
                b = gg(b, c, d, a, k[4], 20, -405537848);
                a = gg(a, b, c, d, k[9], 5, 568446438);
                d = gg(d, a, b, c, k[14], 9, -1019803690);
                c = gg(c, d, a, b, k[3], 14, -187363961);
                b = gg(b, c, d, a, k[8], 20, 1163531501);
                a = gg(a, b, c, d, k[13], 5, -1444681467);
                d = gg(d, a, b, c, k[2], 9, -51403784);
                c = gg(c, d, a, b, k[7], 14, 1735328473);
                b = gg(b, c, d, a, k[12], 20, -1926607734);
                a = hh(a, b, c, d, k[5], 4, -378558);
                d = hh(d, a, b, c, k[8], 11, -2022574463);
                c = hh(c, d, a, b, k[11], 16, 1839030562);
                b = hh(b, c, d, a, k[14], 23, -35309556);
                a = hh(a, b, c, d, k[1], 4, -1530992060);
                d = hh(d, a, b, c, k[4], 11, 1272893353);
                c = hh(c, d, a, b, k[7], 16, -155497632);
                b = hh(b, c, d, a, k[10], 23, -1094730640);
                a = hh(a, b, c, d, k[13], 4, 681279174);
                d = hh(d, a, b, c, k[0], 11, -358537222);
                c = hh(c, d, a, b, k[3], 16, -722521979);
                b = hh(b, c, d, a, k[6], 23, 76029189);
                a = hh(a, b, c, d, k[9], 4, -640364487);
                d = hh(d, a, b, c, k[12], 11, -421815835);
                c = hh(c, d, a, b, k[15], 16, 530742520);
                b = hh(b, c, d, a, k[2], 23, -995338651);
                a = ii(a, b, c, d, k[0], 6, -198630844);
                d = ii(d, a, b, c, k[7], 10, 1126891415);
                c = ii(c, d, a, b, k[14], 15, -1416354905);
                b = ii(b, c, d, a, k[5], 21, -57434055);
                a = ii(a, b, c, d, k[12], 6, 1700485571);
                d = ii(d, a, b, c, k[3], 10, -1894986606);
                c = ii(c, d, a, b, k[10], 15, -1051523);
                b = ii(b, c, d, a, k[1], 21, -2054922799);
                a = ii(a, b, c, d, k[8], 6, 1873313359);
                d = ii(d, a, b, c, k[15], 10, -30611744);
                c = ii(c, d, a, b, k[6], 15, -1560198380);
                b = ii(b, c, d, a, k[13], 21, 1309151649);
                a = ii(a, b, c, d, k[4], 6, -145523070);
                d = ii(d, a, b, c, k[11], 10, -1120210379);
                c = ii(c, d, a, b, k[2], 15, 718787259);
                b = ii(b, c, d, a, k[9], 21, -343485551);
                x[0] = add32(a, x[0]);
                x[1] = add32(b, x[1]);
                x[2] = add32(c, x[2]);
                x[3] = add32(d, x[3]);
            }
            function cmn(q, a, b, x, s, t) {
                a = add32(add32(a, q), add32(x, t));
                return add32((a << s) | (a >>> (32 - s)), b);
            }
            function ff(a, b, c, d, x, s, t) {
                return cmn((b & c) | ((~b) & d), a, b, x, s, t);
            }
            function gg(a, b, c, d, x, s, t) {
                return cmn((b & d) | (c & (~d)), a, b, x, s, t);
            }
            function hh(a, b, c, d, x, s, t) {
                return cmn(b ^ c ^ d, a, b, x, s, t);
            }
            function ii(a, b, c, d, x, s, t) {
                return cmn(c ^ (b | (~d)), a, b, x, s, t);
            }
            function md51(s) {
                var n = s.length, state = [1732584193, -271733879, -1732584194, 271733878], i;
                for (i = 64; i <= s.length; i += 64) {
                    md5cycle(state, md5blk(s.substring(i - 64, i)));
                }
                s = s.substring(i - 64);
                var tail = [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0];
                for (i = 0; i < s.length; i++)
                    tail[i>>2] |= s.charCodeAt(i) << ((i%4) << 3);
                tail[i>>2] |= 0x80 << ((i%4) << 3);
                if (i > 55) {
                    md5cycle(state, tail);
                    for (i = 0; i < 16; i++) tail[i] = 0;
                }
                tail[14] = n*8;
                md5cycle(state, tail);
                return state;
            }
            function md5blk(s) {
                var md5blks = [], i;
                for (i = 0; i < 64; i += 4) {
                    md5blks[i>>2] = s.charCodeAt(i)
                        + (s.charCodeAt(i+1) << 8)
                        + (s.charCodeAt(i+2) << 16)
                        + (s.charCodeAt(i+3) << 24);
                }
                return md5blks;
            }
            var hex_chr = '0123456789abcdef'.split('');
            function rhex(n) {
                var s='', j=0;
                for(; j<4; j++)
                    s += hex_chr[(n >> (j * 8 + 4)) & 0x0F]
                        + hex_chr[(n >> (j * 8)) & 0x0F];
                return s;
            }
            function hex(x) {
                for (var i=0; i<x.length; i++)
                    x[i] = rhex(x[i]);
                return x.join('');
            }
            function add32(a, b) {
                return (a + b) & 0xFFFFFFFF;
            }
            return hex(md51(string));
        }

        // Select preferred URL based on current hostname
        function selectPreferredUrl(urls) {
            if (!urls || urls.length === 0) return null;
            if (urls.length === 1) return urls[0];

            const currentHost = window.location.hostname;
            
            // Try to find URL with matching hostname
            for (const url of urls) {
                try {
                    const urlObj = new URL(url);
                    if (urlObj.hostname === currentHost || 
                        urlObj.hostname.endsWith('.' + currentHost) ||
                        currentHost.endsWith('.' + urlObj.hostname)) {
                        return url;
                    }
                } catch (e) {
                    console.warn('Invalid URL:', url, e);
                }
            }
            
            // Default to first URL
            return urls[0];
        }

        // Render a service card
        function renderServiceCard(app) {
            const link = document.createElement('a');
            link.href = '#';
            
            const card = document.createElement('div');
            card.className = 'service-card';

            // Add icon if present
            if (app.icon) {
                const icon = document.createElement('img');
                icon.src = app.icon;
                icon.alt = app.name;
                icon.className = 'service-icon';
                icon.onerror = function() {
                    // Hide icon if it fails to load
                    this.style.display = 'none';
                };
                card.appendChild(icon);
            } else {
                // Add default icon or emoji if no icon specified
                const iconSpan = document.createElement('span');
                iconSpan.className = 'service-icon service-icon-fallback';
                iconSpan.textContent = 'ðŸ“¦';
                iconSpan.style.fontSize = '48px';
                iconSpan.style.display = 'flex';
                iconSpan.style.alignItems = 'center';
                iconSpan.style.justifyContent = 'center';
                card.appendChild(iconSpan);
            }

            // Service info container
            const info = document.createElement('div');
            info.className = 'service-info';

            // Add status dot if enabled
            if (config.show_status_dot) {
                const statusDot = document.createElement('div');
                statusDot.className = 'status-dot status-online';
                info.appendChild(statusDot);
            }

            // Service name
            const name = document.createElement('div');
            name.className = 'service-name';
            name.textContent = app.name;
            info.appendChild(name);

            // Service URL (preferred)
            const preferredUrl = selectPreferredUrl(app.urls);
            if (preferredUrl) {
                const url = document.createElement('div');
                url.className = 'service-url';
                url.textContent = preferredUrl;
                info.appendChild(url);
                
                // Setup click handler
                link.onclick = (e) => {
                    e.preventDefault();
                    if (config.open_in_new_tab) {
                        window.open(preferredUrl, '_blank');
                    } else {
                        window.location.href = preferredUrl;
                    }
                };
            }

            card.appendChild(info);
            link.appendChild(card);
            
            return link;
        }

        // Render apps
        function renderApps(apps) {
            const mainGrid = document.getElementById('mainServicesGrid');
            const adminGrid = document.getElementById('adminServicesGrid');
            const adminSection = document.getElementById('adminSection');
            
            mainGrid.innerHTML = '';
            adminGrid.innerHTML = '';

            // Sort apps based on config
            if (config.sort_by === 'name') {
                apps.sort((a, b) => a.name.localeCompare(b.name));
            }

            let hasAdminApps = false;

            // Render each app
            apps.forEach(app => {
                const card = renderServiceCard(app);
                
                // Check if this is an admin app (category contains "Admin")
                if (app.category && app.category.toLowerCase().includes('admin')) {
                    adminGrid.appendChild(card);
                    hasAdminApps = true;
                } else {
                    mainGrid.appendChild(card);
                }
            });

            // Show admin section if there are admin apps
            if (hasAdminApps) {
                adminSection.classList.add('visible');
                setupAdminToggle();
            }
        }

        // Setup admin section toggle
        function setupAdminToggle() {
            const adminHeader = document.getElementById('adminHeader');
            const adminToggle = document.getElementById('adminToggle');
            const adminContent = document.getElementById('adminContent');

            adminHeader.onclick = () => {
                const isExpanded = adminContent.classList.contains('expanded');
                if (isExpanded) {
                    adminContent.classList.remove('expanded');
                    adminToggle.classList.remove('expanded');
                } else {
                    adminContent.classList.add('expanded');
                    adminToggle.classList.add('expanded');
                }
            };
        }

        // Load apps
        fetch('/apps.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load apps.json');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                
                // Apply configuration if present
                if (data.config) {
                    applyConfig(data.config);
                }
                
                // Set generated time
                if (data._generated) {
                    const genTime = new Date(data._generated);
                    document.getElementById('generated-time').textContent = genTime.toLocaleString();
                }
                
                if (data.apps && data.apps.length > 0) {
                    renderApps(data.apps);
                } else {
                    document.getElementById('error').textContent = 'No apps found';
                    document.getElementById('error').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading apps:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = 'Failed to load apps: ' + error.message;
                document.getElementById('error').style.display = 'block';
            });
    </script>
</body>
</html>
